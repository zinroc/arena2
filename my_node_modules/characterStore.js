var Promise = Promise || require("bluebird");

var utils = require("../utils.js");


var popCap = 1000;
/**
 * Interacts with character state
 * Requires knex when loaded
 */
module.exports = function (knex) {
    this.knex = knex;

    return {
        /**
        * Get characterInfo
        */
        get: function (){
            return knex("characters")
            .select("*")
            .then(function (rows){
                return rows;
            })
        },
        /**
        * Create a character
        */
        create: function (name){
            return knex("characters")
            .insert({name: name})
            .returning("id")
            .then(function (rows){
                return rows[0];
            })
        },
        createPop: function (){

            return this.get()
            .then(function (characterArr){
                var charactersForCreation = popCap - characterArr.length;
                console.log(charactersForCreation);
                var promises = [];
                var characterStore = require("./characterStore.js")(knex);
                for (var i=0; i<charactersForCreation; i++){
                    var name = utils.newName();
                    promises[i] = characterStore.create(name);
                }
                return Promise.all(promises);
            }).then(function (ids){
                return ids;
            });
        }
    };
};