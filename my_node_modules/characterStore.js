var Promise = Promise || require("bluebird");

var utils = require("../utils.js");




var popCap = 10;
/**
 * Interacts with character state
 * Requires knex when loaded
 */
module.exports = function (knex) {
    this.knex = knex;



    return {
        /**
        * Get characterInfo
        * currently not called
        */
        get: function (){
            return knex("characters")
            .select("*")
            .then(function (rows){
                return rows;
            })
        },
        /**
        * Get characterInfo
        * currently called from client
        */
        getPlayerCharacters: function (email){
            return knex("characters")
            .where("owner", email)
            .select("*")
            .then(function (rows){
                return rows;
            })
        },
        /**
        * Create a character
        * Called from server.
        */
        create: function (name){
            return knex("characters")
            .insert({name: name})
            .returning("id")
            .then(function (rows){
                return rows[0];
            });
        },
        /**
        * Create a character owned by a player
        * STRING name
        * Called from client
        */
        createPlayerCharacter: function (email, name, family_name){
            return knex("characters")
            .insert({name: name, family_name: family_name, owner: email})
            .returning("id")
            .then(function (rows){
                return rows[0];
            });
        },
        /**
        * Delete a character owned by a player
        * INT id from characters(id)
        * Called from client
        */
        deletePlayerCharacter: function (email, id){
            return knex("characters")
            .where({owner: email, id: id})
            .del()
            .then(function (){
                return true;
            });
        },
        /**
        * Spawn a character owned by a player into a location
        * INT id from characters(id)
        *  STRING location 
        * Called from client
        */
        spawnPlayerCharacter: function (email, id, location){
            return knex("characters")
            .where({owner: email, id: id})
            .update({location: location})
            .then(function (){
                return true;
            });
        },
        /*
        * Called from server.
        */
        createPop: function (){

            return this.get()
            .then(function (characterArr){
                var charactersForCreation = popCap - characterArr.length;
                var promises = [];
                for (var i=0; i<charactersForCreation; i++){
                    var name = utils.newName();
                    var characterStore = require("./characterStore.js")(knex);
                    promises[i] = characterStore.create(name);
                }
                return Promise.all(promises);
            }).then(function (ids){
                return ids;
            });
        },
        /**
        * Called from client
        *   @params email STRING
        *   @params id INT refrences characters(id)
        *   @params destination STRING
        */
        beginTraveling: function (email, id, destination){
            return knex("characters")
            .where({owner: email, id: id})
            .update({destination: destination, travel_progress: 0})
            .then(function () {
                return true;
            });
        }

    };
};