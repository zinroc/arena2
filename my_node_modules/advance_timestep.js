module.exports = function (knex) {
        var gameStateStore = require("./gameStateStore.js")(knex),
            characterStore = require("./characterStore.js")(knex),
            playerStore = require("./playerStore.js")(knex);


    return {
        /**
        * Advance timestep, meant to be called from server-side only.
        *
        * @param gs     row in game_state table
        * @return Promise, resolving to updated game_state object
        */
        internalAdvanceTimestep: function (gs) {

            return characterStore.findSuccessfulTravelers()
            .then(function () {
                return characterStore.moveTravelers(gs.timestep);
            }).then(function () {
                return characterStore.arriveAtDestination(gs.timestep);
            }).then(function () {
            }).then(function () { 
                gs.timestep++;
                return gameStateStore.update(gs)
            }).then(function (rValue) {
                return gameStateStore.get();
            });
        }
    };
};